{
  "feature": "User Management Hooks Completion",
  "workflow_type": "simple",
  "workflow_rationale": "Single-service task with one primary file to modify (useUsers.ts). All service layer methods, types, and UI components already exist. No cross-service coordination, infrastructure changes, or complex dependencies. This is a straightforward implementation following an existing pattern (useProducts.ts). The spec explicitly states this is completing TODO markers in an existing hook, not building a full-featured system.",
  "subtasks": [
    {
      "id": "subtask-1",
      "description": "Create query keys object for user cache management",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Export const userQueryKeys object with hierarchical cache keys: all, lists(), list(filters), infinite(filters), details(), detail(id)",
        "pattern_reference": "Follow exact structure from productQueryKeys in useProducts.ts lines 7-17",
        "acceptance": "Query keys object exported and properly typed with 'as const' assertions"
      }
    },
    {
      "id": "subtask-2",
      "description": "Implement useUsers() hook for filtered user fetching",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Replace useState/useEffect with useQuery hook that calls userService.getUsers(filters). Accept FilterParams (search, role, status). Set staleTime: 5min, gcTime: 10min.",
        "pattern_reference": "Copy useProducts() structure from useProducts.ts lines 20-27",
        "acceptance": "Returns { data, isLoading, error, isError, refetch } from React Query"
      }
    },
    {
      "id": "subtask-3",
      "description": "Implement useInfiniteUsers() hook for paginated user fetching",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Create useInfiniteQuery hook for pagination. Accept filters and limit (default 50). Use pageParam for page tracking, implement getNextPageParam.",
        "pattern_reference": "Copy useInfiniteProducts() from useProducts.ts lines 30-41",
        "acceptance": "Returns { data, fetchNextPage, hasNextPage, isFetchingNextPage }",
        "note": "userService.getUsers() doesn't currently support pagination - may need to add pagination logic to service OR skip this if not needed for MVP"
      }
    },
    {
      "id": "subtask-4",
      "description": "Implement useUser(userId) hook for single user details",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Create useQuery hook that calls userService.getUserById(userId). Use enabled option to only fetch when userId is truthy.",
        "pattern_reference": "Copy useProduct() from useProducts.ts lines 65-73",
        "acceptance": "Fetches single user by ID, only when userId provided"
      }
    },
    {
      "id": "subtask-5",
      "description": "Implement useUpdateUser() mutation hook",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Create useMutation hook that calls userService.updateUser(id, data). Add onSuccess callback to invalidate userQueryKeys.all. Return mutate, mutateAsync, isPending, error.",
        "pattern_reference": "Follow useProductAvailability() pattern from useProducts.ts lines 76-87",
        "acceptance": "Updates user and invalidates cache to trigger refetch"
      }
    },
    {
      "id": "subtask-6",
      "description": "Implement useToggleUserStatus() mutation hook",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Create useMutation hook that calls userService.toggleUserStatus(id, isActive). Invalidate cache on success.",
        "pattern_reference": "Follow mutation pattern from useProducts.ts lines 76-87",
        "acceptance": "Toggles user active status and refreshes UI"
      }
    },
    {
      "id": "subtask-7",
      "description": "Implement useDeleteUser() mutation hook",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Create useMutation hook that calls userService.deleteUser(id). Invalidate cache on success to remove deleted user from UI. Note: This is HARD delete, not soft delete (per spec).",
        "pattern_reference": "Follow mutation pattern from useProducts.ts lines 76-87",
        "acceptance": "Deletes user and removes from cache immediately"
      }
    },
    {
      "id": "subtask-8",
      "description": "Add proper TypeScript imports and exports",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [
        "frontend/src/hooks/useProducts.ts"
      ],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check",
        "expected": "No TypeScript errors"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Import useQuery, useInfiniteQuery, useMutation, useQueryClient from @tanstack/react-query. Import userService from @/lib/services/admin/user.service. Import types (User, UserFormData, FilterParams) from @/types/admin. Export all hooks and userQueryKeys.",
        "pattern_reference": "Check imports from useProducts.ts lines 1-4",
        "acceptance": "All imports correct, no linting errors, all hooks exported"
      }
    },
    {
      "id": "subtask-9",
      "description": "Remove old useState/useEffect implementation and TODO markers",
      "service": "frontend",
      "files_to_modify": [
        "frontend/src/hooks/useUsers.ts"
      ],
      "files_to_create": [],
      "patterns_from": [],
      "verification": {
        "type": "command",
        "command": "cd frontend && npm run type-check && grep -c TODO frontend/src/hooks/useUsers.ts",
        "expected": "No TypeScript errors and 0 TODO markers"
      },
      "status": "pending",
      "details": {
        "what_to_build": "Delete the old useUsers() implementation with useState and useEffect (lines 12-37). Remove all TODO comments. Clean up unused imports (useState, useEffect if no longer needed).",
        "acceptance": "No TODO markers remain, clean React Query implementation only, file compiles without errors"
      }
    }
  ],
  "summary": {
    "total_subtasks": 9,
    "services_involved": [
      "frontend"
    ],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "N/A - Sequential subtasks",
      "reasoning": "Simple workflow with sequential subtasks in a single file. All subtasks modify the same file (useUsers.ts) so must be done sequentially."
    },
    "estimated_completion_time": "30-45 minutes",
    "key_files": [
      "frontend/src/hooks/useUsers.ts"
    ],
    "pattern_files": [
      "frontend/src/hooks/useProducts.ts",
      "frontend/src/lib/services/admin/user.service.ts",
      "frontend/src/types/admin.ts"
    ],
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 004 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": true,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All TODO markers removed from useUsers.ts",
      "Type checking passes (npm run type-check)",
      "UserTable component works without modification",
      "All hooks return proper React Query responses",
      "Cache invalidation works after mutations",
      "No console errors in browser",
      "Loading and error states properly exposed",
      "Security scan passes (no secrets, proper RLS enforcement)"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Type Check",
        "command": "cd frontend && npm run type-check",
        "expected_outcome": "No TypeScript errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests - Hooks",
        "command": "cd frontend && npm run test:hooks",
        "expected_outcome": "All hook tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "cd frontend && npm run test:integration",
        "expected_outcome": "Hook + service integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Secrets Scan",
        "command": "python auto-claude/scan_secrets.py --files frontend/src/hooks/useUsers.ts --json",
        "expected_outcome": "No secrets detected",
        "type": "security",
        "required": true,
        "blocking": true
      },
      {
        "name": "Linting",
        "command": "cd frontend && npm run lint",
        "expected_outcome": "No linting errors",
        "type": "test",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk due to user role changes affecting authorization. Requires unit tests for hook logic (filtering, pagination, cache), integration tests for service calls, and security scan to ensure no credentials exposed and RLS properly enforced."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd frontend && npm run test:hooks"
      ],
      "minimum_coverage": null,
      "test_files": [
        "frontend/__tests__/hooks/useUsers.test.tsx"
      ],
      "critical_tests": [
        "useUsers hook returns users data",
        "useUsers applies role filter correctly",
        "useUsers applies status filter correctly",
        "useUser fetches single user by ID",
        "useUpdateUser mutation updates user and invalidates cache",
        "useToggleUserStatus mutation updates status",
        "useDeleteUser mutation removes user from cache",
        "Error handling for failed API calls"
      ]
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "cd frontend && npm run test:integration"
      ],
      "services_to_test": [
        "frontend"
      ],
      "critical_flows": [
        "Hook calls userService.getUsers with correct filters",
        "Mutations trigger cache invalidation",
        "Filter parameters translate to correct Supabase queries"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": [],
      "notes": "E2E tests not strictly required for this hook-only change. Manual browser verification sufficient."
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/dashboard/admin/users",
          "checks": [
            "UserTable displays users without errors",
            "Role filter dropdown works",
            "Status filter works",
            "Search filter works",
            "Edit user modal opens and saves",
            "Toggle status updates badge",
            "Delete confirmation dialog appears",
            "Deleting user removes from table without refresh",
            "Loading skeleton shows while fetching",
            "Error message displays if fetch fails",
            "No console errors or warnings"
          ]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "Users fetched from Supabase profiles table",
        "Role filter applies `.eq('role', ...)` query",
        "Status filter applies `.eq('is_active', ...)` query",
        "Update mutation persists to database",
        "Delete mutation removes row from profiles table (hard delete, not soft)",
        "RLS policies enforced (admin-only access)"
      ]
    },
    "security_checks": {
      "required": true,
      "checks": [
        "No credentials or secrets in code",
        "Supabase RLS policies prevent unauthorized access",
        "Role changes validated server-side via RLS",
        "Delete operations confirmed by user in UI"
      ]
    }
  },
  "qa_signoff": null,
  "notes": [
    "This is a SIMPLE workflow - single file, single service, no dependencies",
    "All service methods already exist in userService - just need React Query wrapper",
    "All types already defined in @/types/admin",
    "UserTable component already expects the new hook interface",
    "Follow useProducts.ts pattern exactly for consistency",
    "IMPORTANT: Spec explicitly excludes: user creation, soft delete, audit logging, email functionality, bulk operations",
    "Service uses HARD delete, not soft delete",
    "subtask-3 (useInfiniteUsers) may be optional if service doesn't support pagination yet",
    "Security is critical: role changes affect authorization, deletions are destructive"
  ],
  "phases": []
}