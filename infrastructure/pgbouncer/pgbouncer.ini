;;;
;;; PgBouncer Configuration
;;; Created: 2025-11-25
;;; Purpose: Connection pooling for PostgreSQL to achieve 5X connection efficiency
;;; Target: Reduce connections from 500 â†’ 100, improve query throughput
;;;

[databases]
;;; Database connections
;;; Format: dbname = host=hostname port=port dbname=database
;;;
;;; Production database (self-hosted Supabase on Contabo VPS)
production = host=data.greenland77.ge port=5432 dbname=postgres

;;; Development database (hosted Supabase)
development = host=db.akxmacfsltzhbnunoepb.supabase.co port=5432 dbname=postgres

[pgbouncer]
;;;
;;; Administrative settings
;;;

;;; Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

;;; Authentication type
;;; md5 = MD5-based password authentication (recommended for Supabase)
auth_type = md5

;;; Auth file with user credentials
;;; Format: "username" "password"
auth_file = /etc/pgbouncer/userlist.txt

;;;
;;; Connection Pooling Settings
;;;

;;; Pool mode
;;; - transaction: Server connection released after each transaction (RECOMMENDED for web apps)
;;; - session: Server connection kept for entire client session
;;; - statement: Server connection released after each statement
;;;
;;; IMPORTANT: Transaction mode provides 5X better connection efficiency
pool_mode = transaction

;;; Maximum number of client connections allowed
max_client_conn = 100

;;; Default pool size per user+database pair
;;; This is the target number of server connections to maintain
default_pool_size = 20

;;; Reserve pool - additional connections allowed beyond default_pool_size when under load
;;; Allows burst capacity without permanent connection overhead
reserve_pool_size = 5

;;; How long to wait for a connection from reserve pool before rejecting (seconds)
reserve_pool_timeout = 3

;;;
;;; Connection Lifetime & Timeouts
;;;

;;; Close server connection if it has been idle for this long (seconds)
;;; Helps reclaim connections during low-traffic periods
server_idle_timeout = 600

;;; Maximum server connection lifetime (seconds)
;;; Forces connection recycling to avoid stale connections
server_lifetime = 3600

;;; Maximum time for a client query (seconds)
;;; Protects against runaway queries
query_timeout = 120

;;; Wait time for server connection (seconds)
server_connect_timeout = 15

;;; Wait time for server login (seconds)
server_login_retry = 15

;;;
;;; Logging
;;;

;;; Log verbosity
;;; 0 = errors only
;;; 1 = warnings
;;; 2 = info (RECOMMENDED for monitoring)
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;;;
;;; Performance Tuning
;;;

;;; DNS lookup caching (seconds)
dns_max_ttl = 15

;;; DNS lookup failure caching (seconds)
dns_nxdomain_ttl = 15

;;;
;;; Admin Settings
;;;

;;; Admin users (comma-separated)
;;; These users can connect to special 'pgbouncer' database for stats
admin_users = postgres

;;; Stats users (comma-separated)
;;; These users can view stats but not change config
stats_users = stats_user

;;; Optional: Application name passed to PostgreSQL
application_name_add_host = 1

;;;
;;; Security
;;;

;;; Disable JIT for better performance with PgBouncer
;;; (JIT optimization happens at application level, not needed in pooler)
server_reset_query = DISCARD ALL

;;; Client TLS settings (optional - uncomment if using TLS)
; client_tls_sslmode = require
; client_tls_cert_file = /etc/pgbouncer/client.crt
; client_tls_key_file = /etc/pgbouncer/client.key
; client_tls_ca_file = /etc/pgbouncer/ca.crt

;;; Server TLS settings (optional - uncomment if connecting to PostgreSQL via TLS)
; server_tls_sslmode = require
; server_tls_cert_file = /etc/pgbouncer/server.crt
; server_tls_key_file = /etc/pgbouncer/server.key
; server_tls_ca_file = /etc/pgbouncer/ca.crt

;;;
;;; Monitoring
;;;

;;; Collect statistics
track_extra_parameters = IntervalStyle

;;;
;;; Notes:
;;;
;;; 1. Transaction mode provides best connection efficiency for stateless web apps
;;; 2. Pool size (20) + reserve pool (5) = max 25 server connections per database
;;; 3. With 100 max client connections, we get 4:1 pooling ratio (5X better than 1:1)
;;; 4. Timeouts prevent resource exhaustion from slow/stuck queries
;;; 5. Connection recycling (server_lifetime) prevents stale connection issues
;;;
;;; To view pool stats:
;;;   psql -p 6432 -U postgres pgbouncer -c "SHOW POOLS"
;;;   psql -p 6432 -U postgres pgbouncer -c "SHOW STATS"
;;;   psql -p 6432 -U postgres pgbouncer -c "SHOW DATABASES"
;;;
